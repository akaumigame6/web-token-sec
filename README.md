# トークンベース認証APP

## 概要

このプロジェクトは **ウェブアプリのセキュリティ実験用のコンテンツ** です。セキュリティに対する理解を深めるためにゼロからユーザ認証を実装した物になります。

## セットアップ手順

### 1. リポジトリのクローン

```
git clone https://github.com/akaumigame6/web-token-sec.git
cd web-token-sec
```

上記でクローンすると、カレントフォルダのなかに `web-token-sec` というフォルダが新規作成されて展開されます。別名にしたいときは、たとえば `hoge` というフォルダにクローンしたいときは、次のようにしてください。

```
git clone https://github.com/akaumigame6/web-token-sec.git hoge
cd hoge
```

### 2. 依存関係のインストール

```bash
npm i
```

### 3. 環境変数の設定ファイル (.env) の作成

プロジェクトのルートフォルダに `.env` (環境変数の設定ファイル) を新規作成して以下の内容を記述してください。

```
DATABASE_URL="file:./app.db"
JWT_SECRET=ABCDEFG123456789UVWXYZ
CSRF_SECRET=HIJKLMN987654321STUVWX
```

- `JWT_SECRET` は認証処理に必要な秘密キーです。安全性を確保するため、適当なランダムな英数字を用いた **16文字以上の文字列** に置き換えてください。文字数が不十分だと、動作時にエラーとなる可能性があります。
- `CSRF_SECRET` はCSRF攻撃対策に必要な秘密キーです。`JWT_SECRET`とは異なる **16文字以上のランダム文字列** を設定してください。


### 4. データベースの初期化

```bash
npx prisma db push
npx prisma generate
npx prisma db seed
```

### 5. 開発サーバの起動

```bash
npm run dev
```

### 6. ビルドと実行

```bash
npm run build
npm run start
```

- データベースの状態確認

```bash
npx prisma studio
```

## 技術スタック
### フロントエンド
- Next.js 15.3.3
  - React フレームワーク（App Router使用）
- TypeScript - 型安全性の確保
- TailwindCSS - レスポンシブデザイン

### バックエンド
- Next.js API Routes - サーバーサイドAPI
- Prisma ORM - データベース操作

### セキュリティ
- bcrypt - パスワードハッシュ化
- jose - JWT操作
- zod - バリデーション
- zxcvbn - パスワードの強度確認

## 主要機能

### 🔐 **認証・アカウント管理**
- **ユーザー登録**  
![ユーザー登録画面](image/Signup.png)  
 - メールアドレス
 - パスワード
 - 秘密の質問
 での新規アカウント作成
- **ログイン・ログアウト**  
![ログイン画面](image/Login.png)
 - JWT（JSON Web Token）ベースの認証システム
- **パスワードリセット** 
![パスワードリセット画面1](image/PasswordReset-1.png) 
![パスワードリセット画面2](image/PasswordReset-2.png) 
![パスワードリセット画面3](image/PasswordReset-3.png) 
 - メールアドレス＋秘密の質問による本人確認後のパスワード変更

### 👤 **プロフィール管理**
![プロフィール画面](image/About.png) 
- **公開プロフィール作成**: カスタムURL（スラッグ）での個人ページ作成
- **プロフィール編集**: About情報のリアルタイム編集・プレビュー機能
- **アカウント設定**: 秘密の質問の変更（ログイン必須）

## 実装しているセキュリティ機能
### ユーザー登録・サインアップ
![ユーザー登録画面](image/Signup.png) 
#### パスワードセキュリティ
- **パスワード強度表示**: zxcvbnライブラリによるリアルタイム強度評価
- **確認パスワード**: パスワード入力ミスを防ぐダブルチェック

#### 秘密の質問システム
![秘密の質問画面](image/PasswordReset-2.png) 
- **本人確認用質問**: アカウント登録時に秘密の質問と答えを設定

#### 未ログイン状態でのパスワードリセット
- **メールアドレス認証**: パスワードリセット開始時にメールアドレスを入力
- **秘密の質問による本人確認**: メールアドレスに紐づく秘密の質問で認証
- **時間制限付きリセットトークン**: 10分間有効なワンタイムトークン

### アカウント設定変更機能
#### 秘密の質問更新（ログイン必須）
- **JWT認証必須**: ログインユーザーのみアクセス可能
- **現在パスワード確認**: パスワード検証による本人確認
- **即座反映**: 新しい秘密の質問設定は即座に有効化
- **外部アクセス防止**: 認証なしのAPIアクセスを完全ブロック

## セキュリティレベル評価

### ✅ **実装済みセキュリティ機能**
- **パスワードハッシュ化**: bcryptjs使用（ソルト付き）
- **JWT署名検証**: HMAC-SHA256による改竄防止
- **入力値検証**: Zodによる型安全なバリデーション
- **SQL インジェクション対策**: Prisma ORM による自動対策
- **認証必須API**: 重要操作での厳格なJWT検証

#### セキュリティヘッダー
- **CSP（Content Security Policy）**: XSS攻撃対策の強化版ポリシー
  - `unsafe-eval` 禁止、外部スクリプト制限
  - オブジェクト・フレーム埋め込み禁止
  - HTTPS自動アップグレード
- **クリックジャッキング対策**: X-Frame-Options: DENY
- **MIME スニッフィング対策**: X-Content-Type-Options: nosniff
- **XSS フィルター**: X-XSS-Protection: 1; mode=block
- **リファラー制御**: Referrer-Policy: strict-origin-when-cross-origin
- **権限ポリシー**: カメラ・マイク・位置情報アクセス禁止
- **HSTS**: 本番環境でHTTPS強制（2年間）
- **Cross-Origin ポリシー**: 本番環境で追加保護

#### ブルートフォース攻撃対策
- **ログイン試行制限**: 15分間で5回まで
- **パスワードリセット制限**: 1時間で3回まで
- **サインアップ制限**: 1時間で5回まで
- **レート制限ヘッダー**: 残り回数・リセット時間を通知

#### セキュリティ監査
- **包括的ログ**: ログイン・認証失敗・セキュリティ違反を記録
- **IPアドレス追跡**: クライアント識別とプロキシ対応
- **ユーザーエージェント記録**: デバイス・ブラウザ情報
- **リアルタイム監視**: 疑わしい活動の即座検知

#### CSRF対策
- **CSRFトークン**: 時間制限付きHMAC署名
- **Double Submit Cookie**: Cookie + ヘッダーの二重検証
- **同一サイト制限**: SameSite=Strict Cookie設定

### ⚠️ **セキュリティ改善余地**
- **セッション管理**: JWTの強制失効機能なし
- **MFA（多要素認証）**: SMS/TOTP認証が未実装
- **不正検知**: 機械学習ベースの異常検知なし
- **データ暗号化**: 保存データの暗号化なし

### 🔒 **本格運用時の追加推奨事項**
- **JWTブラックリスト**: トークン強制失効機能
- **多要素認証（MFA）**: SMS/TOTP/WebAuthn認証の追加
- **機械学習ベース不正検知**: 異常なログインパターンの自動検知
- **定期的パスワード変更**: パスワード有効期限とポリシーエンジン
- **データベース暗号化**: 保存データのAES暗号化
- **WAF（Web Application Firewall）**: アプリケーションレベル保護
- **ペネトレーションテスト**: 定期的な脆弱性診断
- **セキュリティ監視センター**: 24/7リアルタイム監視